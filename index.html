<!doctype html>
<html>
    <head>
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no"
        />
        <style>
            body,
            html {
                margin: 0;
                padding: 0;
                font-family: "Nova Square", monospace;
                font-weight: 700;
                background: black;
                width: 100%;
                height: 100%;
                overflow: hidden;
                /* Safe area support for iPhone notches */
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }

            canvas {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                z-index: 1;
            }
        </style>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Nova+Square&display=swap"
            rel="stylesheet"
        />
        <script>
            (function (i, s, o, g, r, a, m) {
                i["GoogleAnalyticsObject"] = r;
                ((i[r] =
                    i[r] ||
                    function () {
                        (i[r].q = i[r].q || []).push(arguments);
                    }),
                    (i[r].l = 1 * new Date()));
                ((a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]));
                a.async = 1;
                a.src = g;
                m.parentNode.insertBefore(a, m);
            })(
                window,
                document,
                "script",
                "https://www.google-analytics.com/analytics.js",
                "ga",
            );

            ga("create", "UA-105384030-1", "auto");
            ga("send", "pageview");
        </script>
        <title>Disorientation</title>
    </head>

    <body>
        <canvas
            id="canvas"
            width="1000"
            height="600"
            align="left"
            style="
                opacity: 0;
                transition: opacity 0.5s ease-in;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                object-fit: contain;
            "
        >
            Your browser does not support the HTML5 Canvas tag, please stop
            using Internet Explorer.
        </canvas>

        <!-- CRT Filter Integration -->
        <script type="module">
            import { CRTFilterWebGL } from "./CRTFilter.js";

            // Initialize CRT filter after canvas is ready
            let crtFilter = null;
            let crtEnabled = false;

            // CRT toggle function - accessible globally
            window.toggleCRT = function () {
                if (!crtFilter) {
                    const canvas = document.getElementById("canvas");
                    crtFilter = new CRTFilterWebGL(canvas, {
                        barrelDistortion: 0.05,
                        curvature: 0.003,
                        chromaticAberration: 0.0021,
                        staticNoise: 0.012,
                        horizontalTearing: 0.002,
                        glowBloom: 0.0,
                        verticalJitter: 0.002,
                        retraceLines: true,
                        scanlineIntensity: 0.2,
                        dotMask: false,
                        brightness: 0.87,
                        contrast: 1.15,
                        desaturation: 0.08,
                        flicker: 0.015,
                        signalLoss: 0.125,
                    });
                    window.crtFilter = crtFilter; // Expose the filter instance globally
                }

                if (crtEnabled) {
                    crtFilter.stop();
                    crtEnabled = false;
                    window.crtEnabled = false;
                    console.log("CRT filter disabled");
                } else {
                    crtFilter.start();
                    crtEnabled = true;
                    window.crtEnabled = true;
                    console.log("CRT filter enabled");
                }
            };

            // Function to temporarily intensify CRT effects for dramatic moments
            window.crtBurst = function (duration = 1000) {
                if (!crtFilter || !crtEnabled) return;

                const original = {
                    staticNoise: crtFilter.config.staticNoise,
                    flicker: crtFilter.config.flicker,
                    signalLoss: crtFilter.config.signalLoss,
                    verticalJitter: crtFilter.config.verticalJitter,
                };

                crtFilter.config.staticNoise = 0.03;
                crtFilter.config.flicker = 0.08;
                crtFilter.config.signalLoss = 0.1;
                crtFilter.config.verticalJitter = 0.008;
                window._crtGlitchOverrideUntil = performance.now() + duration;

                setTimeout(() => {
                    if (crtFilter && crtEnabled) {
                        Object.assign(crtFilter.config, original);
                    }
                }, duration);
            };

            // Heavier glitch burst for intense moments (e.g., being grabbed)
            window.crtHeavyGlitch = function (duration = 1800) {
                if (!crtFilter || !crtEnabled) return;

                const original = { ...crtFilter.config };

                // Push many parameters much harder for a short, chaotic glitch
                Object.assign(crtFilter.config, {
                    staticNoise: 0.12,
                    flicker: 0.18,
                    signalLoss: 0.22,
                    verticalJitter: 0.02,
                    horizontalTearing: 0.01,
                    barrelDistortion: 0.18,
                    curvature: 0.01,
                    chromaticAberration: 0.01,
                    scanlineIntensity: 0.35,
                    brightness: 0.8,
                    contrast: 1.25,
                    desaturation: 0.18,
                });
                window._crtGlitchOverrideUntil = performance.now() + duration;

                setTimeout(() => {
                    if (crtFilter && crtEnabled) {
                        Object.assign(crtFilter.config, original);
                    }
                }, duration);
            };

            // Auto-enable CRT filter after a short delay
            window.addEventListener("load", () => {
                setTimeout(() => {
                    if (typeof window.toggleCRT === "function") {
                        window.toggleCRT();
                    }
                }, 1500);
            });
        </script>

        <!-- Third-party libraries -->
        <script src="./src/utils/VirtualJoystick.js"></script>

        <!-- Core utilities -->
        <script src="./src/utils/GameUtils.js"></script>
        <script src="./src/utils/Camera.js"></script>

        <!-- Core systems -->
        <script src="./src/systems/PhysicsSystem.js"></script>
        <script src="./src/systems/MazeSystem.js"></script>
        <script src="./src/systems/CameraSystem.js"></script>
        <script src="./src/systems/InputSystem.js"></script>
        <script src="./src/systems/AudioSystem.js"></script>
        <script src="./src/systems/PelletSystem.js"></script>
        <script src="./src/systems/HorrorSystem.js"></script>
        <script src="./src/systems/HorrorEffects/HorrorEffect.js"></script>
        <script src="./src/systems/HorrorEffects/HorrorAudio.js"></script>
        <script src="./src/systems/HorrorEffects/HorrorUI.js"></script>
        <script src="./src/systems/HorrorEffects/HorrorCRT.js"></script>
        <script src="./src/systems/HorrorEffects/HorrorCorruptMaze.js"></script>
        <script src="./src/systems/HorrorEffects/HorrorGhost.js"></script>

        <!-- Effects and UI -->
        <script src="./src/effects/EffectsSystem.js"></script>
        <script src="./src/ui/UISystem.js"></script>

        <!-- Entities -->
        <script src="./src/entities/Player.js"></script>
        <script src="./src/entities/Ghost.js"></script>

        <!-- Core game -->
        <script src="./src/core/GameCore.js"></script>
        <script src="./src/core/GameInit.js"></script>

        <!--
    Game initialized!

    The modular structure allows for easy extension:

    1. Add custom systems: window.gameInit.addCustomSystem('mySystem', new MySystem())
    2. Add custom entities: window.gameInit.addCustomEntity('myEntity', new MyEntity())
    3. Hook into game events: window.game.addHook('onLevelComplete', myCallback)
    4. Access any system: window.game.systems.physics, window.game.systems.maze, etc.
    5. Modify configs: window.game.systems.physics.configure({MAX_SPEED: 500})

    Example hook usage:
    window.game.addHook('onPelletCollected', (player, pellet) => {
      console.log(`Custom pellet collection logic! Player: ${player}, Pellet Type: ${pellet.type}`);
      // Add your own logic here
    });

    Example custom system:
    class MyCustomSystem {
      update(dt) { /* your logic */ }
      render(ctx) { /* your rendering */ }
    }
    window.gameInit.addCustomSystem('myCustom', new MyCustomSystem());

    Debug mode: Press F3 for debug panel, F1 for performance overlay
  -->
    </body>
</html>
